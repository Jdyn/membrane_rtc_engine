!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["membrane-sfu"]=t():e["membrane-sfu"]=t()}(this,(function(){return function(e){var t={};function a(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,a),n.l=!0,n.exports}return a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(i,n,function(t){return e[t]}.bind(null,n));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t,a){"use strict";function i(e){return JSON.stringify(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.MembraneWebRTC=void 0;t.MembraneWebRTC=class{constructor(e){this.localTracksWithStreams=[],this.midToTrackMetadata=new Map,this.localTrackIdToMetadata=new Map,this.midToStream=new Map,this.idToPeer=new Map,this.midToPeer=new Map,this.rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},this.join=e=>{var t,a;try{let t=!1,a=!1;this.localTracksWithStreams.forEach(({stream:e})=>{e.getAudioTracks()!==[]&&(t=!0),e.getVideoTracks()!==[]&&(a=!0)});let n=this.generateMediaEvent("join",{relayAudio:t,relayVideo:a,receiveMedia:this.receiveMedia,metadata:e,tracksMetadata:Array.from(this.localTrackIdToMetadata.values())});this.callbacks.onSendMediaEvent(i(n))}catch(e){null===(a=(t=this.callbacks).onConnectionError)||void 0===a||a.call(t,e),this.leave()}},this.receiveMediaEvent=e=>{var t,a,i,n,r,o;const c=(s=e,JSON.parse(s));var s;switch(c.type){case"peerAccepted":this.id=c.data.id,null===(a=(t=this.callbacks).onJoined)||void 0===a||a.call(t,c.data.id,c.data.peersInRoom),c.data.peersInRoom.forEach(e=>{this.addPeer(e)});break;case"peerDenied":null===(n=(i=this.callbacks).onDenied)||void 0===n||n.call(i);break;case"sdpOffer":this.onOffer(c.data);break;case"candidate":this.onRemoteCandidate(c.data);break;case"peerJoined":const e=c.data.peer;e.id!=this.id&&this.onPeerJoined(e);break;case"peerLeft":this.onPeerLeft(c.data.peerId);break;case"error":null===(o=(r=this.callbacks).onConnectionError)||void 0===o||o.call(r,c.data.message),this.leave()}},this.leave=()=>{let e=this.generateMediaEvent("leave");this.callbacks.onSendMediaEvent(i(e)),this.cleanUp()},this.cleanUp=()=>{this.connection&&(this.connection.onicecandidate=null,this.connection.ontrack=null),this.localTracksWithStreams.forEach(({track:e})=>e.stop()),this.localTracksWithStreams=[],this.connection=void 0},this.onOffer=async e=>{this.connection?this.connection.createOffer({iceRestart:!0}):(this.connection=new RTCPeerConnection(this.rtcConfig),this.connection.onicecandidate=this.onLocalCandidate(),this.connection.ontrack=this.onTrack(),this.localTracksWithStreams.forEach(({track:e,stream:t})=>{this.connection.addTrack(e,t)}));try{await this.connection.setRemoteDescription(e);const t=await this.connection.createAnswer();await this.connection.setLocalDescription(t);const a={};this.connection.getTransceivers().forEach(e=>{var t;const i=null===(t=e.sender.track)||void 0===t?void 0:t.id,n=e.mid;i&&n&&(this.midToTrackMetadata.set(n,this.localTrackIdToMetadata.get(i)),a[n]=this.localTrackIdToMetadata.get(i))});let n=this.generateMediaEvent("sdpAnswer",{sdpAnswer:t,midToTrackMetadata:a});this.callbacks.onSendMediaEvent(i(n))}catch(e){console.error(e)}},this.onRemoteCandidate=e=>{try{const t=new RTCIceCandidate(e);if(!this.connection)throw new Error("Received new remote candidate but RTCConnection is undefined");this.connection.addIceCandidate(t)}catch(e){console.error(e)}},this.onLocalCandidate=()=>e=>{if(e.candidate){let t=this.generateMediaEvent("candidate",{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex});this.callbacks.onSendMediaEvent(i(t))}},this.onTrack=()=>e=>{var t,a;const[i]=e.streams,n=e.transceiver.mid,r=this.midToPeer.get(n);this.midToStream.set(n,i),i.onremovetrack=t=>{var a,o;i.getTracks().length>0||(this.midToStream.delete(n),i.onremovetrack=null),null===(o=(a=this.callbacks).onTrackRemoved)||void 0===o||o.call(a,{peer:r,track:t.track,stream:i,mid:e.transceiver.mid,metadata:this.midToTrackMetadata.get(n)})},null===(a=(t=this.callbacks).onTrackAdded)||void 0===a||a.call(t,{track:e.track,peer:r,stream:i,mid:e.transceiver.mid,metadata:this.midToTrackMetadata.get(n)})},this.onPeerJoined=e=>{var t,a;this.addPeer(e),null===(a=(t=this.callbacks).onPeerJoined)||void 0===a||a.call(t,e)},this.onPeerLeft=e=>{var t,a;const i=this.idToPeer.get(e);i&&(this.removePeer(i),null===(a=(t=this.callbacks).onPeerLeft)||void 0===a||a.call(t,i))},this.addPeer=e=>{for(let t in e.midToTrackMetadata)this.midToPeer.set(t,e),this.midToTrackMetadata.set(t,e.midToTrackMetadata[t]);this.idToPeer.set(e.id,e)},this.removePeer=e=>{for(let t in e.midToTrackMetadata)this.midToPeer.delete(t),this.midToTrackMetadata.delete(t);this.idToPeer.delete(e.id)},this.generateMediaEvent=(e,t)=>{var a={type:e};return t&&(a={...a,data:t}),a};const{receiveMedia:t=!0,callbacks:a,rtcConfig:n}=e;this.receiveMedia=t,this.callbacks=a,this.rtcConfig=n||this.rtcConfig}addLocalTrack(e,t,a={}){this.localTracksWithStreams.push({track:e,stream:t}),this.localTrackIdToMetadata.set(e.id,a)}}}])}));