(()=>{var Ut=Object.create;var F=Object.defineProperty,Nt=Object.defineProperties,Ht=Object.getOwnPropertyDescriptor,$t=Object.getOwnPropertyDescriptors,Vt=Object.getOwnPropertyNames,De=Object.getOwnPropertySymbols,Jt=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty,qt=Object.prototype.propertyIsEnumerable;var Te=(e,t,i)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ue=(e,t)=>{for(var i in t||(t={}))Oe.call(t,i)&&Te(e,i,t[i]);if(De)for(var i of De(t))qt.call(t,i)&&Te(e,i,t[i]);return e},Ne=(e,t)=>Nt(e,$t(t)),He=e=>F(e,"__esModule",{value:!0});var w=(e,t)=>()=>(e&&(t=e(e=0)),t);var ee=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Wt=(e,t)=>{He(e);for(var i in t)F(e,i,{get:t[i],enumerable:!0})},Ft=(e,t,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Vt(t))!Oe.call(e,n)&&n!=="default"&&F(e,n,{get:()=>t[n],enumerable:!(i=Ht(t,n))||i.enumerable});return e},Gt=e=>Ft(He(F(e!=null?Ut(Jt(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);var R=(e,t,i)=>(Te(e,typeof t!="symbol"?t+"":t,i),i);var f=(e,t,i)=>new Promise((n,a)=>{var r=c=>{try{o(i.next(c))}catch(d){a(d)}},s=c=>{try{o(i.throw(c))}catch(d){a(d)}},o=c=>c.done?n(c.value):Promise.resolve(c.value).then(r,s);o((i=i.apply(e,t)).next())});var Ve=ee(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.generateCustomEvent=A.generateMediaEvent=A.deserializeMediaEvent=A.serializeMediaEvent=void 0;function Kt(e){return JSON.stringify(e)}A.serializeMediaEvent=Kt;function Xt(e){return JSON.parse(e)}A.deserializeMediaEvent=Xt;function $e(e,t){var i={type:e};return t&&(i=Ne(Ue({},i),{data:t})),i}A.generateMediaEvent=$e;function Qt(e){return $e("custom",e)}A.generateCustomEvent=Qt});function G(){if(!te&&(te=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto!="undefined"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!te))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return te(Yt)}var te,Yt,ke=w(()=>{Yt=new Uint8Array(16)});var Je,qe=w(()=>{Je=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i});function Zt(e){return typeof e=="string"&&Je.test(e)}var D,K=w(()=>{qe();D=Zt});function zt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=(T[e[t+0]]+T[e[t+1]]+T[e[t+2]]+T[e[t+3]]+"-"+T[e[t+4]]+T[e[t+5]]+"-"+T[e[t+6]]+T[e[t+7]]+"-"+T[e[t+8]]+T[e[t+9]]+"-"+T[e[t+10]]+T[e[t+11]]+T[e[t+12]]+T[e[t+13]]+T[e[t+14]]+T[e[t+15]]).toLowerCase();if(!D(i))throw TypeError("Stringified UUID is invalid");return i}var T,ne,O,X=w(()=>{K();T=[];for(ne=0;ne<256;++ne)T.push((ne+256).toString(16).substr(1));O=zt});function en(e,t,i){var n=t&&i||0,a=t||new Array(16);e=e||{};var r=e.node||We,s=e.clockseq!==void 0?e.clockseq:be;if(r==null||s==null){var o=e.random||(e.rng||G)();r==null&&(r=We=[o[0]|1,o[1],o[2],o[3],o[4],o[5]]),s==null&&(s=be=(o[6]<<8|o[7])&16383)}var c=e.msecs!==void 0?e.msecs:Date.now(),d=e.nsecs!==void 0?e.nsecs:Ee+1,l=c-ye+(d-Ee)/1e4;if(l<0&&e.clockseq===void 0&&(s=s+1&16383),(l<0||c>ye)&&e.nsecs===void 0&&(d=0),d>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");ye=c,Ee=d,be=s,c+=122192928e5;var h=((c&268435455)*1e4+d)%4294967296;a[n++]=h>>>24&255,a[n++]=h>>>16&255,a[n++]=h>>>8&255,a[n++]=h&255;var p=c/4294967296*1e4&268435455;a[n++]=p>>>8&255,a[n++]=p&255,a[n++]=p>>>24&15|16,a[n++]=p>>>16&255,a[n++]=s>>>8|128,a[n++]=s&255;for(var v=0;v<6;++v)a[n+v]=r[v];return t||O(a)}var We,be,ye,Ee,Fe,Ge=w(()=>{ke();X();ye=0,Ee=0;Fe=en});function tn(e){if(!D(e))throw TypeError("Invalid UUID");var t,i=new Uint8Array(16);return i[0]=(t=parseInt(e.slice(0,8),16))>>>24,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=t&255,i[4]=(t=parseInt(e.slice(9,13),16))>>>8,i[5]=t&255,i[6]=(t=parseInt(e.slice(14,18),16))>>>8,i[7]=t&255,i[8]=(t=parseInt(e.slice(19,23),16))>>>8,i[9]=t&255,i[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,i[11]=t/4294967296&255,i[12]=t>>>24&255,i[13]=t>>>16&255,i[14]=t>>>8&255,i[15]=t&255,i}var ie,we=w(()=>{K();ie=tn});function nn(e){e=unescape(encodeURIComponent(e));for(var t=[],i=0;i<e.length;++i)t.push(e.charCodeAt(i));return t}function ae(e,t,i){function n(a,r,s,o){if(typeof a=="string"&&(a=nn(a)),typeof r=="string"&&(r=ie(r)),r.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var c=new Uint8Array(16+a.length);if(c.set(r),c.set(a,r.length),c=i(c),c[6]=c[6]&15|t,c[8]=c[8]&63|128,s){o=o||0;for(var d=0;d<16;++d)s[o+d]=c[d];return s}return O(c)}try{n.name=e}catch(a){}return n.DNS=an,n.URL=rn,n}var an,rn,Ce=w(()=>{X();we();an="6ba7b810-9dad-11d1-80b4-00c04fd430c8",rn="6ba7b811-9dad-11d1-80b4-00c04fd430c8"});function sn(e){if(typeof e=="string"){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var i=0;i<t.length;++i)e[i]=t.charCodeAt(i)}return on(cn(dn(e),e.length*8))}function on(e){for(var t=[],i=e.length*32,n="0123456789abcdef",a=0;a<i;a+=8){var r=e[a>>5]>>>a%32&255,s=parseInt(n.charAt(r>>>4&15)+n.charAt(r&15),16);t.push(s)}return t}function Ke(e){return(e+64>>>9<<4)+14+1}function cn(e,t){e[t>>5]|=128<<t%32,e[Ke(t)-1]=t;for(var i=1732584193,n=-271733879,a=-1732584194,r=271733878,s=0;s<e.length;s+=16){var o=i,c=n,d=a,l=r;i=k(i,n,a,r,e[s],7,-680876936),r=k(r,i,n,a,e[s+1],12,-389564586),a=k(a,r,i,n,e[s+2],17,606105819),n=k(n,a,r,i,e[s+3],22,-1044525330),i=k(i,n,a,r,e[s+4],7,-176418897),r=k(r,i,n,a,e[s+5],12,1200080426),a=k(a,r,i,n,e[s+6],17,-1473231341),n=k(n,a,r,i,e[s+7],22,-45705983),i=k(i,n,a,r,e[s+8],7,1770035416),r=k(r,i,n,a,e[s+9],12,-1958414417),a=k(a,r,i,n,e[s+10],17,-42063),n=k(n,a,r,i,e[s+11],22,-1990404162),i=k(i,n,a,r,e[s+12],7,1804603682),r=k(r,i,n,a,e[s+13],12,-40341101),a=k(a,r,i,n,e[s+14],17,-1502002290),n=k(n,a,r,i,e[s+15],22,1236535329),i=b(i,n,a,r,e[s+1],5,-165796510),r=b(r,i,n,a,e[s+6],9,-1069501632),a=b(a,r,i,n,e[s+11],14,643717713),n=b(n,a,r,i,e[s],20,-373897302),i=b(i,n,a,r,e[s+5],5,-701558691),r=b(r,i,n,a,e[s+10],9,38016083),a=b(a,r,i,n,e[s+15],14,-660478335),n=b(n,a,r,i,e[s+4],20,-405537848),i=b(i,n,a,r,e[s+9],5,568446438),r=b(r,i,n,a,e[s+14],9,-1019803690),a=b(a,r,i,n,e[s+3],14,-187363961),n=b(n,a,r,i,e[s+8],20,1163531501),i=b(i,n,a,r,e[s+13],5,-1444681467),r=b(r,i,n,a,e[s+2],9,-51403784),a=b(a,r,i,n,e[s+7],14,1735328473),n=b(n,a,r,i,e[s+12],20,-1926607734),i=y(i,n,a,r,e[s+5],4,-378558),r=y(r,i,n,a,e[s+8],11,-2022574463),a=y(a,r,i,n,e[s+11],16,1839030562),n=y(n,a,r,i,e[s+14],23,-35309556),i=y(i,n,a,r,e[s+1],4,-1530992060),r=y(r,i,n,a,e[s+4],11,1272893353),a=y(a,r,i,n,e[s+7],16,-155497632),n=y(n,a,r,i,e[s+10],23,-1094730640),i=y(i,n,a,r,e[s+13],4,681279174),r=y(r,i,n,a,e[s],11,-358537222),a=y(a,r,i,n,e[s+3],16,-722521979),n=y(n,a,r,i,e[s+6],23,76029189),i=y(i,n,a,r,e[s+9],4,-640364487),r=y(r,i,n,a,e[s+12],11,-421815835),a=y(a,r,i,n,e[s+15],16,530742520),n=y(n,a,r,i,e[s+2],23,-995338651),i=E(i,n,a,r,e[s],6,-198630844),r=E(r,i,n,a,e[s+7],10,1126891415),a=E(a,r,i,n,e[s+14],15,-1416354905),n=E(n,a,r,i,e[s+5],21,-57434055),i=E(i,n,a,r,e[s+12],6,1700485571),r=E(r,i,n,a,e[s+3],10,-1894986606),a=E(a,r,i,n,e[s+10],15,-1051523),n=E(n,a,r,i,e[s+1],21,-2054922799),i=E(i,n,a,r,e[s+8],6,1873313359),r=E(r,i,n,a,e[s+15],10,-30611744),a=E(a,r,i,n,e[s+6],15,-1560198380),n=E(n,a,r,i,e[s+13],21,1309151649),i=E(i,n,a,r,e[s+4],6,-145523070),r=E(r,i,n,a,e[s+11],10,-1120210379),a=E(a,r,i,n,e[s+2],15,718787259),n=E(n,a,r,i,e[s+9],21,-343485551),i=U(i,o),n=U(n,c),a=U(a,d),r=U(r,l)}return[i,n,a,r]}function dn(e){if(e.length===0)return[];for(var t=e.length*8,i=new Uint32Array(Ke(t)),n=0;n<t;n+=8)i[n>>5]|=(e[n/8]&255)<<n%32;return i}function U(e,t){var i=(e&65535)+(t&65535),n=(e>>16)+(t>>16)+(i>>16);return n<<16|i&65535}function ln(e,t){return e<<t|e>>>32-t}function re(e,t,i,n,a,r){return U(ln(U(U(t,e),U(n,r)),a),i)}function k(e,t,i,n,a,r,s){return re(t&i|~t&n,e,t,a,r,s)}function b(e,t,i,n,a,r,s){return re(t&n|i&~n,e,t,a,r,s)}function y(e,t,i,n,a,r,s){return re(t^i^n,e,t,a,r,s)}function E(e,t,i,n,a,r,s){return re(i^(t|~n),e,t,a,r,s)}var Xe,Qe=w(()=>{Xe=sn});var hn,Ye,Ze=w(()=>{Ce();Qe();hn=ae("v3",48,Xe),Ye=hn});function fn(e,t,i){e=e||{};var n=e.random||(e.rng||G)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,t){i=i||0;for(var a=0;a<16;++a)t[i+a]=n[a];return t}return O(n)}var ze,et=w(()=>{ke();X();ze=fn});function un(e,t,i,n){switch(e){case 0:return t&i^~t&n;case 1:return t^i^n;case 2:return t&i^t&n^i&n;case 3:return t^i^n}}function Se(e,t){return e<<t|e>>>32-t}function mn(e){var t=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof e=="string"){var n=unescape(encodeURIComponent(e));e=[];for(var a=0;a<n.length;++a)e.push(n.charCodeAt(a))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var r=e.length/4+2,s=Math.ceil(r/16),o=new Array(s),c=0;c<s;++c){for(var d=new Uint32Array(16),l=0;l<16;++l)d[l]=e[c*64+l*4]<<24|e[c*64+l*4+1]<<16|e[c*64+l*4+2]<<8|e[c*64+l*4+3];o[c]=d}o[s-1][14]=(e.length-1)*8/Math.pow(2,32),o[s-1][14]=Math.floor(o[s-1][14]),o[s-1][15]=(e.length-1)*8&4294967295;for(var h=0;h<s;++h){for(var p=new Uint32Array(80),v=0;v<16;++v)p[v]=o[h][v];for(var M=16;M<80;++M)p[M]=Se(p[M-3]^p[M-8]^p[M-14]^p[M-16],1);for(var L=i[0],N=i[1],B=i[2],H=i[3],$=i[4],V=0;V<80;++V){var J=Math.floor(V/20),z=Se(L,5)+un(J,N,B,H)+$+t[J]+p[V]>>>0;$=H,H=B,B=Se(N,30)>>>0,N=L,L=z}i[0]=i[0]+L>>>0,i[1]=i[1]+N>>>0,i[2]=i[2]+B>>>0,i[3]=i[3]+H>>>0,i[4]=i[4]+$>>>0}return[i[0]>>24&255,i[0]>>16&255,i[0]>>8&255,i[0]&255,i[1]>>24&255,i[1]>>16&255,i[1]>>8&255,i[1]&255,i[2]>>24&255,i[2]>>16&255,i[2]>>8&255,i[2]&255,i[3]>>24&255,i[3]>>16&255,i[3]>>8&255,i[3]&255,i[4]>>24&255,i[4]>>16&255,i[4]>>8&255,i[4]&255]}var tt,nt=w(()=>{tt=mn});var pn,it,at=w(()=>{Ce();nt();pn=ae("v5",80,tt),it=pn});var rt,st=w(()=>{rt="00000000-0000-0000-0000-000000000000"});function gn(e){if(!D(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)}var ot,ct=w(()=>{K();ot=gn});var dt={};Wt(dt,{NIL:()=>rt,parse:()=>ie,stringify:()=>O,v1:()=>Fe,v3:()=>Ye,v4:()=>ze,v5:()=>it,validate:()=>D,version:()=>ot});var lt=w(()=>{Ge();Ze();et();at();st();ct();K();X();we()});var ht=ee(se=>{"use strict";Object.defineProperty(se,"__esModule",{value:!0});se.simulcastTransceiverConfig=void 0;se.simulcastTransceiverConfig={direction:"sendonly",sendEncodings:[{rid:"l",active:!1,scaleResolutionDownBy:4},{rid:"m",active:!1,scaleResolutionDownBy:2},{rid:"h",active:!1}]}});var ut=ee(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.MembraneWebRTC=void 0;var C=Ve(),vn=(lt(),dt),Tn=ht(),ft=class{constructor(t){this.localTracksWithStreams=[],this.trackIdToTrack=new Map,this.idToPeer=new Map,this.localPeer={id:"",metadata:{},trackIdToMetadata:new Map},this.localTrackIdToTrack=new Map,this.midToTrackId=new Map,this.disabledTrackEncodings=new Map,this.rtcConfig={iceServers:[],iceTransportPolicy:"relay"},this.join=n=>{var a,r;try{this.localPeer.metadata=n;let s=(0,C.generateMediaEvent)("join",{metadata:n});this.sendMediaEvent(s)}catch(s){(r=(a=this.callbacks).onConnectionError)===null||r===void 0||r.call(a,s),this.leave()}},this.receiveMediaEvent=n=>{var a,r,s,o;let c=(0,C.deserializeMediaEvent)(n);switch(c.type){case"peerAccepted":this.localPeer.id=c.data.id,(r=(a=this.callbacks).onJoinSuccess)===null||r===void 0||r.call(a,c.data.id,c.data.peersInRoom),c.data.peersInRoom.forEach(l=>{this.addPeer(l)});break;case"peerDenied":(o=(s=this.callbacks).onJoinError)===null||o===void 0||o.call(s,c.data);break;default:this.localPeer.id!=null&&this.handleMediaEvent(c)}},this.handleMediaEvent=n=>{var a,r,s,o,c,d,l,h,p,v,M,L,N,B,H,$,V,J,z,ve;let u,j;switch(n.type){case"offerData":let _t=n.data.integratedTurnServers;this.setTurns(_t);let Lt=new Map(Object.entries(n.data.tracksTypes));this.onOfferData(Lt);break;case"tracksAdded":if(j=n.data,this.getPeerId()===j.peerId)return;j.trackIdToMetadata=new Map(Object.entries(j.trackIdToMetadata)),u=this.idToPeer.get(j.peerId);let Bt=u.trackIdToMetadata;u.trackIdToMetadata=new Map([...u.trackIdToMetadata,...j.trackIdToMetadata]),this.idToPeer.set(u.id,u),Array.from(u.trackIdToMetadata.entries()).forEach(([g,P])=>{var S,W;if(!Bt.has(g)){let Be={stream:null,track:null,trackId:g,simulcastConfig:{enabled:!1,active_encodings:[]},metadata:P,peer:u,maxBandwidth:0};this.trackIdToTrack.set(g,Be),(W=(S=this.callbacks).onTrackAdded)===null||W===void 0||W.call(S,Be)}});break;case"tracksRemoved":j=n.data;let Dt=j.peerId;if(this.getPeerId()===j.peerId)return;j.trackIds.forEach(g=>{var P,S;let W=this.trackIdToTrack.get(g);(S=(P=this.callbacks).onTrackRemoved)===null||S===void 0||S.call(P,W),this.eraseTrack(g,Dt)});break;case"sdpAnswer":this.midToTrackId=new Map(Object.entries(n.data.midToTrackId)),this.onAnswer(n.data);break;case"candidate":this.onRemoteCandidate(n.data);break;case"peerJoined":if(u=n.data.peer,u.id===this.getPeerId())return;this.addPeer(u),(r=(a=this.callbacks).onPeerJoined)===null||r===void 0||r.call(a,u);break;case"peerLeft":if(u=this.idToPeer.get(n.data.peerId),u===void 0)return;Array.from(u.trackIdToMetadata.keys()).forEach(g=>{var P,S;return(S=(P=this.callbacks).onTrackRemoved)===null||S===void 0?void 0:S.call(P,this.trackIdToTrack.get(g))}),this.erasePeer(u),(o=(s=this.callbacks).onPeerLeft)===null||o===void 0||o.call(s,u);break;case"peerUpdated":if(this.getPeerId()===n.data.peerId)return;u=this.idToPeer.get(n.data.peerId),u.metadata=n.data.metadata,this.addPeer(u),(d=(c=this.callbacks).onPeerUpdated)===null||d===void 0||d.call(c,u);break;case"peerRemoved":if(this.getPeerId()!==n.data.peerId){console.error("Received onRemoved media event, but it does not refer to the local peer");return}(h=(l=this.callbacks).onRemoved)===null||h===void 0||h.call(l,n.data.reason);break;case"trackUpdated":{if(this.getPeerId()===n.data.peerId)return;if(u=this.idToPeer.get(n.data.peerId),u==null)throw`Peer with id: ${n.data.peerId} doesn't exist`;let g=n.data.trackId,P=n.data.metadata;u.trackIdToMetadata.set(g,P);let S=this.trackIdToTrack.get(g);S.metadata=P,(v=(p=this.callbacks).onTrackUpdated)===null||v===void 0||v.call(p,S);break}case"tracksPriority":let Le=n.data.tracks.map(g=>this.trackIdToTrack.get(g)),Ot=Array.from(this.trackIdToTrack.values()).filter(g=>!Le.includes(g));(L=(M=this.callbacks).onTracksPriorityChanged)===null||L===void 0||L.call(M,Le,Ot);case"encodingSwitched":(B=(N=this.callbacks).onTrackEncodingChanged)===null||B===void 0||B.call(N,n.data.peerId,n.data.trackId,n.data.encoding);break;case"custom":this.handleMediaEvent(n.data);break;case"error":($=(H=this.callbacks).onConnectionError)===null||$===void 0||$.call(H,n.data.message),this.leave();break;case"vadNotification":{let g=n.data.trackId,P=this.trackIdToTrack.get(g).peer.id;(J=(V=this.callbacks).onVoiceActivityChanged)===null||J===void 0||J.call(V,P,g,n.data.status);break}case"bandwidthEstimation":{let g=n.data.estimation;(ve=(z=this.callbacks).onBandwidthEstimationChanged)===null||ve===void 0||ve.call(z,g);break}default:console.warn("Received unknown media event: ",n.type);break}},this.addTrackToConnection=n=>{let a=this.createTransceiverConfig(n),r=n.track;this.connection.addTransceiver(r,a)},this.updatePeerMetadata=n=>{let a=(0,C.generateMediaEvent)("updatePeerMetadata",{metadata:n});this.sendMediaEvent(a)},this.updateTrackMetadata=(n,a)=>{let r=this.localTrackIdToTrack.get(n);r.metadata=a,this.localTrackIdToTrack.set(n,r),this.localPeer.trackIdToMetadata.set(n,a);let s=(0,C.generateMediaEvent)("updateTrackMetadata",{trackId:n,trackMetadata:a});this.sendMediaEvent(s)},this.getMidToTrackId=()=>{let n={};return this.connection?(this.connection.getTransceivers().forEach(a=>{var r;let s=(r=a.sender.track)===null||r===void 0?void 0:r.id,o=a.mid;if(s&&o){let c=Array.from(this.localTrackIdToTrack.values()).find(d=>d.track.id===s);n[o]=c.trackId}}),n):null},this.leave=()=>{let n=(0,C.generateMediaEvent)("leave");this.sendMediaEvent(n),this.cleanUp()},this.cleanUp=()=>{this.connection&&(this.connection.onicecandidate=null,this.connection.ontrack=null),this.localTracksWithStreams.forEach(({track:n})=>n.stop()),this.localTracksWithStreams=[],this.connection=void 0},this.sendMediaEvent=n=>{this.callbacks.onSendMediaEvent((0,C.serializeMediaEvent)(n))},this.onAnswer=n=>f(this,null,function*(){this.connection.ontrack=this.onTrack();try{yield this.connection.setRemoteDescription(n),this.disabledTrackEncodings.forEach((a,r)=>{a.forEach(s=>this.disableTrackEncoding(r,s))})}catch(a){console.log(a)}}),this.addTransceiversIfNeeded=n=>{var a;let r=this.connection.getTransceivers().filter(l=>l.direction==="recvonly"),s=[],o=l=>{let h=n.get(l);h=h!==void 0?h:0;let p=r.filter(v=>v.receiver.track.kind===l).length;return Array(h-p).fill(l)},c=o("audio"),d=o("video");s=s.concat(c),s=s.concat(d);for(let l of s)(a=this.connection)===null||a===void 0||a.addTransceiver(l,{direction:"recvonly"})},this.getTrackIdToMetadata=()=>{let n={};return Array.from(this.localPeer.trackIdToMetadata.entries()).forEach(([a,r])=>{n[a]=r}),n},this.checkIfTrackBelongToPeer=(n,a)=>Array.from(a.trackIdToMetadata.keys()).some(r=>n.startsWith(r)),this.onOfferData=n=>f(this,null,function*(){this.connection?yield this.connection.restartIce():(this.connection=new RTCPeerConnection(this.rtcConfig),this.connection.onicecandidate=this.onLocalCandidate(),Array.from(this.localTrackIdToTrack.values()).forEach(a=>this.addTrackToConnection(a)),this.connection.getTransceivers().forEach(a=>a.direction="sendonly")),this.addTransceiversIfNeeded(n),yield this.createAndSendOffer()}),this.onRemoteCandidate=n=>{try{let a=new RTCIceCandidate(n);if(!this.connection)throw new Error("Received new remote candidate but RTCConnection is undefined");this.connection.addIceCandidate(a)}catch(a){console.error(a)}},this.onLocalCandidate=()=>n=>{if(n.candidate){let a=(0,C.generateCustomEvent)({type:"candidate",data:{candidate:n.candidate.candidate,sdpMLineIndex:n.candidate.sdpMLineIndex}});this.sendMediaEvent(a)}},this.onTrack=()=>n=>{var a,r;let[s]=n.streams,o=n.transceiver.mid,c=this.midToTrackId.get(o);if(this.checkIfTrackBelongToPeer(c,this.localPeer))return;let d=Array.from(this.idToPeer.values()).filter(p=>this.checkIfTrackBelongToPeer(c,p))[0],l=d.trackIdToMetadata.get(c),h={stream:s,track:n.track,peer:d,trackId:c,metadata:l,simulcastConfig:{enabled:!1,active_encodings:[]}};this.trackIdToTrack.set(c,h),(r=(a=this.callbacks).onTrackReady)===null||r===void 0||r.call(a,h)},this.setTurns=n=>{n.forEach(a=>{var r,s;a.transport=="tls"?(r="tcp",s="turns"):(r=a.transport,s="turn");let o={credential:a.password,credentialType:"password",urls:s.concat(":",a.serverAddr,":",a.serverPort,"?transport=",r),username:a.username};this.rtcConfig.iceServers.push(o)})},this.addPeer=n=>{n.hasOwnProperty("trackIdToMetadata")?n.trackIdToMetadata=new Map(Object.entries(n.trackIdToMetadata)):n.trackIdToMetadata=new Map,this.idToPeer.set(n.id,n)},this.erasePeer=n=>{let a=Array.from(n.trackIdToMetadata.keys());a.forEach(r=>this.trackIdToTrack.delete(r)),Array.from(this.midToTrackId.entries()).forEach(([r,s])=>{a.includes(s)&&this.midToTrackId.delete(r)}),this.idToPeer.delete(n.id)},this.eraseTrack=(n,a)=>{this.trackIdToTrack.delete(n);let r=Array.from(this.midToTrackId.entries()),[s,o]=r.find(([c,d])=>d===n);this.midToTrackId.delete(s),this.idToPeer.get(a).trackIdToMetadata.delete(n),this.disabledTrackEncodings.delete(n)},this.getPeerId=()=>this.localPeer.id;let{callbacks:i}=t;this.callbacks=i}addTrack(t,i,n=new Map,a={enabled:!1,active_encodings:[]},r=0){if(this.getPeerId()==="")throw"Cannot add tracks before being accepted by the server";let s=this.getTrackId((0,vn.v4)());this.localTracksWithStreams.push({track:t,stream:i}),this.localPeer.trackIdToMetadata.set(s,n);let o={track:t,stream:i,trackId:s,peer:this.localPeer,metadata:n,simulcastConfig:a,maxBandwidth:r};this.localTrackIdToTrack.set(s,o),this.connection&&(this.addTrackToConnection(o),this.connection.getTransceivers().forEach(d=>d.direction=d.direction==="sendrecv"?"sendonly":d.direction));let c=(0,C.generateCustomEvent)({type:"renegotiateTracks"});return this.sendMediaEvent(c),s}createTransceiverConfig(t){let i;return t.track.kind==="audio"?i=this.createAudioTransceiverConfig(t):i=this.createVideoTransceiverConfig(t),i}createAudioTransceiverConfig(t){return{direction:"sendonly"}}createVideoTransceiverConfig(t){var i;let n;if(t.simulcastConfig.enabled){n=Tn.simulcastTransceiverConfig;let a=t.simulcastConfig.active_encodings,r=[];(i=n.sendEncodings)===null||i===void 0||i.forEach(s=>{a.includes(s.rid)?s.active=!0:r.push(s.rid)}),this.disabledTrackEncodings.set(t.trackId,r)}else n={direction:"sendonly",sendEncodings:[{active:!0}]};return t.maxBandwidth&&n.sendEncodings&&this.applyBandwidthLimitation(n.sendEncodings,t.maxBandwidth),n}applyBandwidthLimitation(t,i){typeof i=="number"?this.splitBandwidth(t,i*1024):t.filter(n=>n.rid).forEach(n=>{let a=i.get(n.rid)||0;a>0?n.maxBitrate=a*1024:delete n.maxBitrate})}splitBandwidth(t,i){if(i===0){t.forEach(s=>delete s.maxBitrate);return}if(t.length==0){console.error("Attempted to limit bandwidth of the track that doesn't have any encodings");return}let n=t[0].scaleResolutionDownBy||1,a=t.reduce((s,o)=>s+(n/(o.scaleResolutionDownBy||1))**2,0),r=i/a;t.forEach(s=>s.maxBitrate=r*(n/(s.scaleResolutionDownBy||1))**2)}replaceTrack(t,i,n){return f(this,null,function*(){let a=this.localTrackIdToTrack.get(t),r=this.findSender(a.track.id);return r?r.replaceTrack(i).then(()=>{let s=n||this.localTrackIdToTrack.get(t).metadata;return a.track=i,this.updateTrackMetadata(t,s),!0}).catch(()=>!1):!1})}setTrackBandwidth(t,i){let n=this.localTrackIdToTrack.get(t);if(!n)return Promise.reject(`Track '${t}' doesn't exist`);let a=this.findSender(n.track.id),r=a.getParameters();return r.encodings.length===0?r.encodings=[{}]:this.applyBandwidthLimitation(r.encodings,i),a.setParameters(r).then(()=>!0).catch(()=>!1)}setEncodingBandwidth(t,i,n){let a=this.localTrackIdToTrack.get(t);if(!a)return Promise.reject(`Track '${t}' doesn't exist`);let r=this.findSender(a.track.id),s=r.getParameters(),o=s.encodings.find(c=>c.rid===i);if(o)n===0?delete o.maxBitrate:o.maxBitrate=n*1024;else return Promise.reject(`Encoding with rid '${i}' doesn't exist`);return r.setParameters(s).then(()=>!0).catch(c=>!1)}removeTrack(t){let i=this.localTrackIdToTrack.get(t),n=this.findSender(i.track.id);this.connection.removeTrack(n);let a=(0,C.generateCustomEvent)({type:"renegotiateTracks"});this.sendMediaEvent(a),this.localTrackIdToTrack.delete(t),this.localPeer.trackIdToMetadata.delete(t)}prioritizeTrack(t){let i=(0,C.generateCustomEvent)({type:"prioritizeTrack",data:{trackId:t}});this.sendMediaEvent(i)}unprioritizeTrack(t){let i=(0,C.generateCustomEvent)({type:"unprioritizeTrack",data:{trackId:t}});this.sendMediaEvent(i)}setPreferedVideoSizes(t,i,n=0,a=!1){let r=(0,C.generateCustomEvent)({type:"preferedVideoSizes",data:{bigScreens:t,mediumScreens:n,smallScreens:i,allSameSize:a}});this.sendMediaEvent(r)}setTargetTrackEncoding(t,i){let n=(0,C.generateCustomEvent)({type:"setTargetTrackVariant",data:{trackId:t,variant:i}});this.sendMediaEvent(n)}enableTrackEncoding(t,i){var n,a,r;let s=(n=this.localTrackIdToTrack.get(t))===null||n===void 0?void 0:n.track,o=(a=this.disabledTrackEncodings.get(t))===null||a===void 0?void 0:a.filter(l=>l!==i);this.disabledTrackEncodings.set(t,o);let c=(r=this.connection)===null||r===void 0?void 0:r.getSenders().filter(l=>l.track===s)[0],d=c==null?void 0:c.getParameters();d.encodings.filter(l=>l.rid==i)[0].active=!0,c==null||c.setParameters(d)}disableTrackEncoding(t,i){var n,a;let r=(n=this.localTrackIdToTrack.get(t))===null||n===void 0?void 0:n.track;this.disabledTrackEncodings.get(t).push(i);let s=(a=this.connection)===null||a===void 0?void 0:a.getSenders().filter(c=>c.track===r)[0],o=s==null?void 0:s.getParameters();o.encodings.filter(c=>c.rid==i)[0].active=!1,s==null||s.setParameters(o)}findSender(t){return this.connection.getSenders().find(i=>i.track&&i.track.id===t)}getTrackId(t){return`${this.getPeerId()}:${t}`}createAndSendOffer(){return f(this,null,function*(){if(!!this.connection)try{let t=yield this.connection.createOffer();yield this.connection.setLocalDescription(t);let i=(0,C.generateCustomEvent)({type:"sdpOffer",data:{sdpOffer:t,trackIdToTrackMetadata:this.getTrackIdToMetadata(),midToTrackId:this.getMidToTrackId()}});this.sendMediaEvent(i)}catch(t){console.error(t)}})}};oe.MembraneWebRTC=ft});var mt=ee(ce=>{"use strict";Object.defineProperty(ce,"__esModule",{value:!0});ce.MembraneWebRTC=void 0;var kn=ut();Object.defineProperty(ce,"MembraneWebRTC",{enumerable:!0,get:function(){return kn.MembraneWebRTC}})});var vt=Gt(mt());var Q=e=>typeof e=="function"?e:function(){return e},bn=typeof self!="undefined"?self:null,Y=typeof window!="undefined"?window:null,Z=bn||Y||Z,yn="2.0.0",x={connecting:0,open:1,closing:2,closed:3},En=1e4,wn=1e3,I={closed:"closed",errored:"errored",joined:"joined",joining:"joining",leaving:"leaving"},_={close:"phx_close",error:"phx_error",join:"phx_join",reply:"phx_reply",leave:"phx_leave"},Re={longpoll:"longpoll",websocket:"websocket"},Cn={complete:4},de=class{constructor(e,t,i,n){this.channel=e,this.event=t,this.payload=i||function(){return{}},this.receivedResp=null,this.timeout=n,this.timeoutTimer=null,this.recHooks=[],this.sent=!1}resend(e){this.timeout=e,this.reset(),this.send()}send(){this.hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload(),ref:this.ref,join_ref:this.channel.joinRef()}))}receive(e,t){return this.hasReceived(e)&&t(this.receivedResp.response),this.recHooks.push({status:e,callback:t}),this}reset(){this.cancelRefEvent(),this.ref=null,this.refEvent=null,this.receivedResp=null,this.sent=!1}matchReceive({status:e,response:t,_ref:i}){this.recHooks.filter(n=>n.status===e).forEach(n=>n.callback(t))}cancelRefEvent(){!this.refEvent||this.channel.off(this.refEvent)}cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=null}startTimeout(){this.timeoutTimer&&this.cancelTimeout(),this.ref=this.channel.socket.makeRef(),this.refEvent=this.channel.replyEventName(this.ref),this.channel.on(this.refEvent,e=>{this.cancelRefEvent(),this.cancelTimeout(),this.receivedResp=e,this.matchReceive(e)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}trigger(e,t){this.channel.trigger(this.refEvent,{status:e,response:t})}},pt=class{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=null,this.tries=0}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}},Sn=class{constructor(e,t,i){this.state=I.closed,this.topic=e,this.params=Q(t||{}),this.socket=i,this.bindings=[],this.bindingRef=0,this.timeout=this.socket.timeout,this.joinedOnce=!1,this.joinPush=new de(this,_.join,this.params,this.timeout),this.pushBuffer=[],this.stateChangeRefs=[],this.rejoinTimer=new pt(()=>{this.socket.isConnected()&&this.rejoin()},this.socket.rejoinAfterMs),this.stateChangeRefs.push(this.socket.onError(()=>this.rejoinTimer.reset())),this.stateChangeRefs.push(this.socket.onOpen(()=>{this.rejoinTimer.reset(),this.isErrored()&&this.rejoin()})),this.joinPush.receive("ok",()=>{this.state=I.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(n=>n.send()),this.pushBuffer=[]}),this.joinPush.receive("error",()=>{this.state=I.errored,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.onClose(()=>{this.rejoinTimer.reset(),this.socket.hasLogger()&&this.socket.log("channel",`close ${this.topic} ${this.joinRef()}`),this.state=I.closed,this.socket.remove(this)}),this.onError(n=>{this.socket.hasLogger()&&this.socket.log("channel",`error ${this.topic}`,n),this.isJoining()&&this.joinPush.reset(),this.state=I.errored,this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.joinPush.receive("timeout",()=>{this.socket.hasLogger()&&this.socket.log("channel",`timeout ${this.topic} (${this.joinRef()})`,this.joinPush.timeout),new de(this,_.leave,Q({}),this.timeout).send(),this.state=I.errored,this.joinPush.reset(),this.socket.isConnected()&&this.rejoinTimer.scheduleTimeout()}),this.on(_.reply,(n,a)=>{this.trigger(this.replyEventName(a),n)})}join(e=this.timeout){if(this.joinedOnce)throw new Error("tried to join multiple times. 'join' can only be called a single time per channel instance");return this.timeout=e,this.joinedOnce=!0,this.rejoin(),this.joinPush}onClose(e){this.on(_.close,e)}onError(e){return this.on(_.error,t=>e(t))}on(e,t){let i=this.bindingRef++;return this.bindings.push({event:e,ref:i,callback:t}),i}off(e,t){this.bindings=this.bindings.filter(i=>!(i.event===e&&(typeof t=="undefined"||t===i.ref)))}canPush(){return this.socket.isConnected()&&this.isJoined()}push(e,t,i=this.timeout){if(t=t||{},!this.joinedOnce)throw new Error(`tried to push '${e}' to '${this.topic}' before joining. Use channel.join() before pushing events`);let n=new de(this,e,function(){return t},i);return this.canPush()?n.send():(n.startTimeout(),this.pushBuffer.push(n)),n}leave(e=this.timeout){this.rejoinTimer.reset(),this.joinPush.cancelTimeout(),this.state=I.leaving;let t=()=>{this.socket.hasLogger()&&this.socket.log("channel",`leave ${this.topic}`),this.trigger(_.close,"leave")},i=new de(this,_.leave,Q({}),e);return i.receive("ok",()=>t()).receive("timeout",()=>t()),i.send(),this.canPush()||i.trigger("ok",{}),i}onMessage(e,t,i){return t}isMember(e,t,i,n){return this.topic!==e?!1:n&&n!==this.joinRef()?(this.socket.hasLogger()&&this.socket.log("channel","dropping outdated message",{topic:e,event:t,payload:i,joinRef:n}),!1):!0}joinRef(){return this.joinPush.ref}rejoin(e=this.timeout){this.isLeaving()||(this.socket.leaveOpenTopic(this.topic),this.state=I.joining,this.joinPush.resend(e))}trigger(e,t,i,n){let a=this.onMessage(e,t,i,n);if(t&&!a)throw new Error("channel onMessage callbacks must return the payload, modified or unmodified");let r=this.bindings.filter(s=>s.event===e);for(let s=0;s<r.length;s++)r[s].callback(a,i,n||this.joinRef())}replyEventName(e){return`chan_reply_${e}`}isClosed(){return this.state===I.closed}isErrored(){return this.state===I.errored}isJoined(){return this.state===I.joined}isJoining(){return this.state===I.joining}isLeaving(){return this.state===I.leaving}},le=class{static request(e,t,i,n,a,r,s){if(Z.XDomainRequest){let o=new Z.XDomainRequest;return this.xdomainRequest(o,e,t,n,a,r,s)}else{let o=new Z.XMLHttpRequest;return this.xhrRequest(o,e,t,i,n,a,r,s)}}static xdomainRequest(e,t,i,n,a,r,s){return e.timeout=a,e.open(t,i),e.onload=()=>{let o=this.parseJSON(e.responseText);s&&s(o)},r&&(e.ontimeout=r),e.onprogress=()=>{},e.send(n),e}static xhrRequest(e,t,i,n,a,r,s,o){return e.open(t,i,!0),e.timeout=r,e.setRequestHeader("Content-Type",n),e.onerror=()=>o&&o(null),e.onreadystatechange=()=>{if(e.readyState===Cn.complete&&o){let c=this.parseJSON(e.responseText);o(c)}},s&&(e.ontimeout=s),e.send(a),e}static parseJSON(e){if(!e||e==="")return null;try{return JSON.parse(e)}catch(t){return console&&console.log("failed to parse JSON response",e),null}}static serialize(e,t){let i=[];for(var n in e){if(!Object.prototype.hasOwnProperty.call(e,n))continue;let a=t?`${t}[${n}]`:n,r=e[n];typeof r=="object"?i.push(this.serialize(r,a)):i.push(encodeURIComponent(a)+"="+encodeURIComponent(r))}return i.join("&")}static appendParams(e,t){if(Object.keys(t).length===0)return e;let i=e.match(/\?/)?"&":"?";return`${e}${i}${this.serialize(t)}`}},Ie=class{constructor(e){this.endPoint=null,this.token=null,this.skipHeartbeat=!0,this.reqs=new Set,this.onopen=function(){},this.onerror=function(){},this.onmessage=function(){},this.onclose=function(){},this.pollEndpoint=this.normalizeEndpoint(e),this.readyState=x.connecting,this.poll()}normalizeEndpoint(e){return e.replace("ws://","http://").replace("wss://","https://").replace(new RegExp("(.*)/"+Re.websocket),"$1/"+Re.longpoll)}endpointURL(){return le.appendParams(this.pollEndpoint,{token:this.token})}closeAndRetry(e,t,i){this.close(e,t,i),this.readyState=x.connecting}ontimeout(){this.onerror("timeout"),this.closeAndRetry(1005,"timeout",!1)}isActive(){return this.readyState===x.open||this.readyState===x.connecting}poll(){this.ajax("GET",null,()=>this.ontimeout(),e=>{if(e){var{status:t,token:i,messages:n}=e;this.token=i}else t=0;switch(t){case 200:n.forEach(a=>{setTimeout(()=>this.onmessage({data:a}),0)}),this.poll();break;case 204:this.poll();break;case 410:this.readyState=x.open,this.onopen({}),this.poll();break;case 403:this.onerror(403),this.close(1008,"forbidden",!1);break;case 0:case 500:this.onerror(500),this.closeAndRetry(1011,"internal server error",500);break;default:throw new Error(`unhandled poll status ${t}`)}})}send(e){this.ajax("POST",e,()=>this.onerror("timeout"),t=>{(!t||t.status!==200)&&(this.onerror(t&&t.status),this.closeAndRetry(1011,"internal server error",!1))})}close(e,t,i){for(let a of this.reqs)a.abort();this.readyState=x.closed;let n=Object.assign({code:1e3,reason:void 0,wasClean:!0},{code:e,reason:t,wasClean:i});typeof CloseEvent!="undefined"?this.onclose(new CloseEvent("close",n)):this.onclose(n)}ajax(e,t,i,n){let a,r=()=>{this.reqs.delete(a),i()};a=le.request(e,this.endpointURL(),"application/json",t,this.timeout,r,s=>{this.reqs.delete(a),this.isActive()&&n(s)}),this.reqs.add(a)}};var he={HEADER_LENGTH:1,META_LENGTH:4,KINDS:{push:0,reply:1,broadcast:2},encode(e,t){if(e.payload.constructor===ArrayBuffer)return t(this.binaryEncode(e));{let i=[e.join_ref,e.ref,e.topic,e.event,e.payload];return t(JSON.stringify(i))}},decode(e,t){if(e.constructor===ArrayBuffer)return t(this.binaryDecode(e));{let[i,n,a,r,s]=JSON.parse(e);return t({join_ref:i,ref:n,topic:a,event:r,payload:s})}},binaryEncode(e){let{join_ref:t,ref:i,event:n,topic:a,payload:r}=e,s=this.META_LENGTH+t.length+i.length+a.length+n.length,o=new ArrayBuffer(this.HEADER_LENGTH+s),c=new DataView(o),d=0;c.setUint8(d++,this.KINDS.push),c.setUint8(d++,t.length),c.setUint8(d++,i.length),c.setUint8(d++,a.length),c.setUint8(d++,n.length),Array.from(t,h=>c.setUint8(d++,h.charCodeAt(0))),Array.from(i,h=>c.setUint8(d++,h.charCodeAt(0))),Array.from(a,h=>c.setUint8(d++,h.charCodeAt(0))),Array.from(n,h=>c.setUint8(d++,h.charCodeAt(0)));var l=new Uint8Array(o.byteLength+r.byteLength);return l.set(new Uint8Array(o),0),l.set(new Uint8Array(r),o.byteLength),l.buffer},binaryDecode(e){let t=new DataView(e),i=t.getUint8(0),n=new TextDecoder;switch(i){case this.KINDS.push:return this.decodePush(e,t,n);case this.KINDS.reply:return this.decodeReply(e,t,n);case this.KINDS.broadcast:return this.decodeBroadcast(e,t,n)}},decodePush(e,t,i){let n=t.getUint8(1),a=t.getUint8(2),r=t.getUint8(3),s=this.HEADER_LENGTH+this.META_LENGTH-1,o=i.decode(e.slice(s,s+n));s=s+n;let c=i.decode(e.slice(s,s+a));s=s+a;let d=i.decode(e.slice(s,s+r));s=s+r;let l=e.slice(s,e.byteLength);return{join_ref:o,ref:null,topic:c,event:d,payload:l}},decodeReply(e,t,i){let n=t.getUint8(1),a=t.getUint8(2),r=t.getUint8(3),s=t.getUint8(4),o=this.HEADER_LENGTH+this.META_LENGTH,c=i.decode(e.slice(o,o+n));o=o+n;let d=i.decode(e.slice(o,o+a));o=o+a;let l=i.decode(e.slice(o,o+r));o=o+r;let h=i.decode(e.slice(o,o+s));o=o+s;let p=e.slice(o,e.byteLength),v={status:h,response:p};return{join_ref:c,ref:d,topic:l,event:_.reply,payload:v}},decodeBroadcast(e,t,i){let n=t.getUint8(1),a=t.getUint8(2),r=this.HEADER_LENGTH+2,s=i.decode(e.slice(r,r+n));r=r+n;let o=i.decode(e.slice(r,r+a));r=r+a;let c=e.slice(r,e.byteLength);return{join_ref:null,ref:null,topic:s,event:o,payload:c}}},gt=class{constructor(e,t={}){this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.channels=[],this.sendBuffer=[],this.ref=0,this.timeout=t.timeout||En,this.transport=t.transport||Z.WebSocket||Ie,this.establishedConnections=0,this.defaultEncoder=he.encode.bind(he),this.defaultDecoder=he.decode.bind(he),this.closeWasClean=!1,this.binaryType=t.binaryType||"arraybuffer",this.connectClock=1,this.transport!==Ie?(this.encode=t.encode||this.defaultEncoder,this.decode=t.decode||this.defaultDecoder):(this.encode=this.defaultEncoder,this.decode=this.defaultDecoder);let i=null;Y&&Y.addEventListener&&(Y.addEventListener("pagehide",n=>{this.conn&&(this.disconnect(),i=this.connectClock)}),Y.addEventListener("pageshow",n=>{i===this.connectClock&&(i=null,this.connect())})),this.heartbeatIntervalMs=t.heartbeatIntervalMs||3e4,this.rejoinAfterMs=n=>t.rejoinAfterMs?t.rejoinAfterMs(n):[1e3,2e3,5e3][n-1]||1e4,this.reconnectAfterMs=n=>t.reconnectAfterMs?t.reconnectAfterMs(n):[10,50,100,150,200,250,500,1e3,2e3][n-1]||5e3,this.logger=t.logger||null,this.longpollerTimeout=t.longpollerTimeout||2e4,this.params=Q(t.params||{}),this.endPoint=`${e}/${Re.websocket}`,this.vsn=t.vsn||yn,this.heartbeatTimeoutTimer=null,this.heartbeatTimer=null,this.pendingHeartbeatRef=null,this.reconnectTimer=new pt(()=>{this.teardown(()=>this.connect())},this.reconnectAfterMs)}getLongPollTransport(){return Ie}replaceTransport(e){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.sendBuffer=[],this.conn&&(this.conn.close(),this.conn=null),this.transport=e}protocol(){return location.protocol.match(/^https/)?"wss":"ws"}endPointURL(){let e=le.appendParams(le.appendParams(this.endPoint,this.params()),{vsn:this.vsn});return e.charAt(0)!=="/"?e:e.charAt(1)==="/"?`${this.protocol()}:${e}`:`${this.protocol()}://${location.host}${e}`}disconnect(e,t,i){this.connectClock++,this.closeWasClean=!0,this.reconnectTimer.reset(),this.teardown(e,t,i)}connect(e){e&&(console&&console.log("passing params to connect is deprecated. Instead pass :params to the Socket constructor"),this.params=Q(e)),!this.conn&&(this.connectClock++,this.closeWasClean=!1,this.conn=new this.transport(this.endPointURL()),this.conn.binaryType=this.binaryType,this.conn.timeout=this.longpollerTimeout,this.conn.onopen=()=>this.onConnOpen(),this.conn.onerror=t=>this.onConnError(t),this.conn.onmessage=t=>this.onConnMessage(t),this.conn.onclose=t=>this.onConnClose(t))}log(e,t,i){this.logger(e,t,i)}hasLogger(){return this.logger!==null}onOpen(e){let t=this.makeRef();return this.stateChangeCallbacks.open.push([t,e]),t}onClose(e){let t=this.makeRef();return this.stateChangeCallbacks.close.push([t,e]),t}onError(e){let t=this.makeRef();return this.stateChangeCallbacks.error.push([t,e]),t}onMessage(e){let t=this.makeRef();return this.stateChangeCallbacks.message.push([t,e]),t}ping(e){if(!this.isConnected())return!1;let t=this.makeRef(),i=Date.now();this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:t});let n=this.onMessage(a=>{a.ref===t&&(this.off([n]),e(Date.now()-i))});return!0}clearHeartbeats(){clearTimeout(this.heartbeatTimer),clearTimeout(this.heartbeatTimeoutTimer)}onConnOpen(){this.hasLogger()&&this.log("transport",`connected to ${this.endPointURL()}`),this.closeWasClean=!1,this.establishedConnections++,this.flushSendBuffer(),this.reconnectTimer.reset(),this.resetHeartbeat(),this.stateChangeCallbacks.open.forEach(([,e])=>e())}heartbeatTimeout(){this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null,this.hasLogger()&&this.log("transport","heartbeat timeout. Attempting to re-establish connection"),this.triggerChanError(),this.closeWasClean=!1,this.teardown(()=>this.reconnectTimer.scheduleTimeout(),wn,"heartbeat timeout"))}resetHeartbeat(){this.conn&&this.conn.skipHeartbeat||(this.pendingHeartbeatRef=null,this.clearHeartbeats(),this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs))}teardown(e,t,i){if(!this.conn)return e&&e();this.waitForBufferDone(()=>{this.conn&&(t?this.conn.close(t,i||""):this.conn.close()),this.waitForSocketClosed(()=>{this.conn&&(this.conn.onopen=function(){},this.conn.onerror=function(){},this.conn.onmessage=function(){},this.conn.onclose=function(){},this.conn=null),e&&e()})})}waitForBufferDone(e,t=1){if(t===5||!this.conn||!this.conn.bufferedAmount){e();return}setTimeout(()=>{this.waitForBufferDone(e,t+1)},150*t)}waitForSocketClosed(e,t=1){if(t===5||!this.conn||this.conn.readyState===x.closed){e();return}setTimeout(()=>{this.waitForSocketClosed(e,t+1)},150*t)}onConnClose(e){let t=e&&e.code;this.hasLogger()&&this.log("transport","close",e),this.triggerChanError(),this.clearHeartbeats(),!this.closeWasClean&&t!==1e3&&this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(([,i])=>i(e))}onConnError(e){this.hasLogger()&&this.log("transport",e);let t=this.transport,i=this.establishedConnections;this.stateChangeCallbacks.error.forEach(([,n])=>{n(e,t,i)}),(t===this.transport||i>0)&&this.triggerChanError()}triggerChanError(){this.channels.forEach(e=>{e.isErrored()||e.isLeaving()||e.isClosed()||e.trigger(_.error)})}connectionState(){switch(this.conn&&this.conn.readyState){case x.connecting:return"connecting";case x.open:return"open";case x.closing:return"closing";default:return"closed"}}isConnected(){return this.connectionState()==="open"}remove(e){this.off(e.stateChangeRefs),this.channels=this.channels.filter(t=>t.joinRef()!==e.joinRef())}off(e){for(let t in this.stateChangeCallbacks)this.stateChangeCallbacks[t]=this.stateChangeCallbacks[t].filter(([i])=>e.indexOf(i)===-1)}channel(e,t={}){let i=new Sn(e,t,this);return this.channels.push(i),i}push(e){if(this.hasLogger()){let{topic:t,event:i,payload:n,ref:a,join_ref:r}=e;this.log("push",`${t} ${i} (${r}, ${a})`,n)}this.isConnected()?this.encode(e,t=>this.conn.send(t)):this.sendBuffer.push(()=>this.encode(e,t=>this.conn.send(t)))}makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}sendHeartbeat(){this.pendingHeartbeatRef&&!this.isConnected()||(this.pendingHeartbeatRef=this.makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.heartbeatTimeoutTimer=setTimeout(()=>this.heartbeatTimeout(),this.heartbeatIntervalMs))}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}onConnMessage(e){this.decode(e.data,t=>{let{topic:i,event:n,payload:a,ref:r,join_ref:s}=t;r&&r===this.pendingHeartbeatRef&&(this.clearHeartbeats(),this.pendingHeartbeatRef=null,this.heartbeatTimer=setTimeout(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)),this.hasLogger()&&this.log("receive",`${a.status||""} ${i} ${n} ${r&&"("+r+")"||""}`,a);for(let o=0;o<this.channels.length;o++){let c=this.channels[o];!c.isMember(i,n,a,s)||c.trigger(n,a,r,s)}for(let o=0;o<this.stateChangeCallbacks.message.length;o++){let[,c]=this.stateChangeCallbacks.message[o];c(t)}})}leaveOpenTopic(e){let t=this.channels.find(i=>i.topic===e&&(i.isJoined()||i.isJoining()));t&&(this.hasLogger()&&this.log("transport",`leaving duplicate topic "${e}"`),t.leave())}};var Tt=document.querySelector("#videos");function kt(e){let t=document.createElement("video");t.id=e,t.autoplay=!0,t.playsInline=!0,Tt.appendChild(t)}function Rn(e){let t=document.getElementById(e);Tt.removeChild(t)}function In(e){console.error(e)}var bt=class{constructor(t,i){R(this,"addTrack",t=>{let i=!this.simulcast||t.kind=="audio"?this.webrtc.addTrack(t,this.localStream):this.webrtc.addTrack(t,this.localStream,{},{enabled:!0,active_encodings:this.encodings},new Map([["h",1500],["m",500],["l",100]]));t.kind=="audio"?this.audioTrack=[i,t]:this.videoTrack=[i,t]});R(this,"init",()=>f(this,null,function*(){yield this.phoenixChannelPushResult(this.webrtcChannel.join())}));R(this,"join",()=>{this.webrtc.join({displayName:this.displayName})});R(this,"leave",()=>{for(this.webrtc.leave(),this.webrtcChannel.leave(),this.socket.off(this.webrtcSocketRefs);this.webrtcSocketRefs.length>0;)this.webrtcSocketRefs.pop()});R(this,"updateParticipantsList",()=>{let t=this.peers.map(i=>i.metadata.displayName);this.displayName&&t.push(this.displayName)});R(this,"phoenixChannelPushResult",t=>f(this,null,function*(){return new Promise((i,n)=>{t.receive("ok",a=>i(a)).receive("error",a=>n(a))})}));R(this,"disableSimulcastEncoding",t=>{this.webrtc.disableTrackEncoding(this.videoTrack[0],t)});R(this,"enableSimulcastEncoding",t=>{this.webrtc.enableTrackEncoding(this.videoTrack[0],t)});R(this,"selectPeerSimulcastEncoding",t=>{let i=this.peers[0];Array.from(i.trackIdToMetadata.keys()).filter(r=>this.remoteTracks.get(r).track.kind=="video").forEach(r=>this.webrtc.setTargetTrackEncoding(r,t))});R(this,"getPeerEncoding",()=>this.peerEncoding);R(this,"updateMetadata",()=>this.webrtc.updatePeerMetadata("test"));R(this,"updateTrackMetadata",()=>this.webrtc.updateTrackMetadata(this.videoTrack[0],"trackMetadata"));this.localStream=t,this.peers=[],this.socket=new gt("/socket"),this.socket.connect(),this.displayName="local",this.webrtcChannel=this.socket.channel("room"),this.videoTrack=null,this.audioTrack=null,this.peerEncoding="m",this.encodings=["l","m","h"],this.peerMetadata=null,this.trackMetadata=null,this.selfId=null,this.simulcast=i,this.remoteTracks=new Map,this.webrtcSocketRefs=[],this.webrtcSocketRefs.push(this.socket.onError(this.leave)),this.webrtcSocketRefs.push(this.socket.onClose(this.leave)),this.webrtc=new vt.MembraneWebRTC({callbacks:{onSendMediaEvent:n=>{this.webrtcChannel.push("mediaEvent",{data:n})},onConnectionError:In,onJoinSuccess:(n,a)=>{this.selfId=n,this.localStream&&this.localStream.getTracks().forEach(r=>this.addTrack(r)),this.peers=a,this.peers.forEach(r=>{kt(r.id)}),this.updateParticipantsList()},onJoinError:n=>{throw"Peer denied."},onTrackReady:n=>{let a=document.getElementById(n.peer.id);a.srcObject=n.stream,this.remoteTracks.set(n.trackId,n)},onTrackAdded:n=>{console.log(this.selfId," track added ",n.trackId)},onTrackRemoved:n=>{this.remoteTracks.delete(n.trackId)},onPeerJoined:n=>{this.peers.push(n),this.updateParticipantsList(),kt(n.id,n.metadata.displayName,!1)},onPeerLeft:n=>{this.peers=this.peers.filter(a=>a.id!==n.id),Rn(n.id),this.updateParticipantsList()},onPeerUpdated:n=>{this.peerMetadata=n.metadata},onTrackUpdated:n=>{this.trackMetadata=n.metadata},onTrackEncodingChanged:(n,a,r)=>{console.log(this.selfId,"received info that ",n,"changed encoding to ",r),this.peerEncoding=r}}}),this.webrtcChannel.on("mediaEvent",n=>this.webrtc.receiveMediaEvent(n.data))}},yt=bt;var fe=200;function Pn(){if(typeof InstallTrigger!==void 0)return"firefox";if(window.chrome!==void 0)return"chrome";throw new Error("Unknown browser type")}function ue(e){return f(this,null,function*(){return new Promise((t,i)=>{setTimeout(t,e)})})}function Et(e,t){for(let[i,n]of e)if(i.startsWith(t))return n}function Mn(e,t){return f(this,null,function*(){let i=r=>f(this,null,function*(){if(!r)return-1;let s=yield e.getStats(r),o=Et(s,"RTCInboundRTPVideoStream");return o?o.framesDecoded:-1}),n=yield i(t);yield ue(fe);let a=yield i(t);return n>=0&&a>=0?a>n:!1})}function jn(e,t){return f(this,null,function*(){let i=r=>f(this,null,function*(){if(!r)return-1;let s=yield e.getStats(r),o=Et(s,"RTCInboundRTPAudioStream");return o?o.totalAudioEnergy:-1}),n=yield videoFramedDecoded(videoTrack);yield ue(fe);let a=yield i(t);return n>=0&&a>=0?a>n:!1})}function An(e,t){return f(this,null,function*(){let i=r=>{let[,s]=Array.from(r).find(([o,c])=>c.mediaType==="video");return s.packetsReceived},n=i(yield e.getStats(t));yield ue(fe);let a=i(yield e.getStats(t));return n>0&&a>0&&a>n})}function xn(e,t){return f(this,null,function*(){let i=r=>{let[,s]=Array.from(r).find(([o,c])=>c.mediaType==="audio");return s.packetsReceived},n=i(yield e.getStats(t));yield ue(fe);let a=i(yield e.getStats(t));return n>0&&a>0&&a>n})}function wt(e){return f(this,null,function*(){let t=yield e.getStats(),i={height:null,width:null,framesPerSecond:0};for(let[n,a]of t)a.type=="inbound-rtp"&&(i=St(a),i.framesReceived=a.framesReceived);return i})}function Ct(e){return f(this,null,function*(){let t=yield e.getStats(),i={l:null,m:null,h:null};for(let[n,a]of t)if(a.type=="outbound-rtp"){let r=a.rid;i[r]=St(a),i[r].framesSent=a.framesSent,i[r].qualityLimitationDuration=a.qualityLimitationDurations,i[r].qualityLimitationReason=a.qualityLimitationReason}return i})}function St(e){let t={height:null,width:null,framesPerSecond:0};return t.height=e.frameHeight,t.width=e.frameWidth,t.framesPerSecond=e.framesPerSecond!=null?e.framesPerSecond:0,t}function Rt(e){return f(this,null,function*(){let t=e.getRemoteStreams(),i=e.getReceivers().map(({track:a})=>a).filter(a=>!a.muted).map(({id:a})=>a),n=t.map(a=>f(this,null,function*(){let[r=void 0]=a.getAudioTracks(),[s=void 0]=a.getVideoTracks(),o={streamId:a.id,isAudioPlaying:!1,isVideoPlaying:!1};switch(Pn()){case"chrome":{o.isAudioPlaying=yield jn(e,r),o.isVideoPlaying=yield Mn(e,r);break}case"firefox":r&&i.includes(r.id)||s&&i.includes(s.id)||(o.active=!1),o.isAudioPlaying=r!==void 0&&(yield xn(e,r)),o.isVideoPlaying=s!==void 0&&(yield An(e,s))}return o}));return(yield Promise.all(n)).filter(a=>a.active===void 0)})}var Pe=document.querySelector("#videos"),_n=document.querySelector("video#local-video"),me=document.querySelector("div#data"),Me=(e,t)=>e.map(i=>document.querySelector(`button#${t}-${i}`)),pe=Me(["simulcast","all","mic-only","camera-only","none"],"start"),je=Me(["local-low-encoding","local-medium-encoding","local-high-encoding","peer-low-encoding","peer-medium-encoding","peer-high-encoding","inbound-stats","outbound-stats"],"simulcast"),It=Me(["update-peer","update-track","peer","track"],"metadata"),[Ln,Pt,Bn,Dn,On]=pe,[Mt,jt,At,Un,Nn,Hn,$n,Vn]=je,[Jn,qn,Wn,Fn]=It,ge=document.querySelector("button#stop"),xt=document.querySelector("button#stats");pe.forEach(e=>e.disabled=!1);It.forEach(e=>e.disabled=!1);je.forEach(e=>e.disabled=!0);ge.disabled=!0;xt.disabled=!1;var m,Gn={width:{max:1280,ideal:1280,min:1280},height:{max:720,ideal:720,min:720},frameRate:{max:30,ideal:24}};function q(e,t=!1){return f(this,null,function*(){if(m)return;let i=["all","camera"].includes(e);t&&je.map(r=>r.disabled=!1);let n={audio:["all","mic"].includes(e),video:i&&t?Gn:i},a;(n.audio||n.video)&&(a=yield navigator.mediaDevices.getUserMedia(n),window.stream=a),_n.srcObject=a,pe.forEach(r=>r.disabled=!0),ge.disabled=!1,m=new yt(a,t),yield m.init(),yield m.join()})}function Kn(){return f(this,null,function*(){if(!!m){for(m.leave();Pe.children.length>1;)Pe.removeChild(Pe.lastChild);m=void 0,pe.forEach(e=>e.disabled=!1),ge.disabled=!0}})}function Ae(e){me.innerHTML=JSON.stringify(e),me.dataset.version=parseInt(me.dataset.version)+1}function xe(e){return f(this,null,function*(){if(!m||!m.webrtc||!m.webrtc.connection){me.innerHTML=`Room error. One of objects doesn't exists: Room ${!m}, WebRTC ${!m.webrtc}, PeerConnection ${!m.webrtc.connection}`;return}let t=yield e(m.webrtc.connection);Ae(t)})}var _e=function(e,t){let i=e.textContent.startsWith("Disable"),n=e.textContent;i?(m.disableSimulcastEncoding(t),n=n.replace("Disable","Enable")):(m.enableSimulcastEncoding(t),n=n.replace("Enable","Disable")),e.textContent=n};Ln.onclick=()=>q("all",!0);Pt.onclick=()=>q("all");Pt.onclick=()=>q("all");Bn.onclick=()=>q("mic");Dn.onclick=()=>q("camera");On.onclick=()=>q("none");ge.onclick=Kn;xt.onclick=()=>{xe(Rt)};Jn.onclick=()=>{m.updateMetadata()};qn.onclick=()=>{m.updateTrackMetadata()};Wn.onclick=()=>{Ae(m.peerMetadata)};Fn.onclick=()=>{Ae(m.trackMetadata)};Mt.onclick=()=>{_e(Mt,"l")};jt.onclick=()=>{_e(jt,"m")};At.onclick=()=>{_e(At,"h")};Un.onclick=()=>{m.selectPeerSimulcastEncoding("l")};Nn.onclick=()=>{m.selectPeerSimulcastEncoding("m")};Hn.onclick=()=>{m.selectPeerSimulcastEncoding("h")};$n.onclick=()=>{xe(e=>f(void 0,null,function*(){let t=yield wt(e);return t.encoding=m.getPeerEncoding(),t}))};Vn.onclick=()=>{xe(Ct)};})();
